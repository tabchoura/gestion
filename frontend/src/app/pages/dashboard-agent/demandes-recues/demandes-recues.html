<div class="wrap">
  <h2>📋 Demandes Reçues</h2>

  <!-- Messages serveur -->
  <div *ngIf="errorMsg()" class="server-error">{{ errorMsg() }}</div>
  <div *ngIf="successMsg()" class="server-success">{{ successMsg() }}</div>

  <div class="card">

    <!-- HEADER -->
    <div class="thead">
      <div>Statistiques</div>
      <div class="stats">
        <span class="chip">Total: {{ statistiques().total }}</span>
        <span class="chip chip-warn">En attente: {{ statistiques().enAttente }}</span>
        <span class="chip chip-ok">Approuvées: {{ statistiques().approuvees }}</span>
        <span class="chip chip-ko">Rejetées: {{ statistiques().rejetees }}</span>
      </div>
    </div>

    <!-- FILTRES -->
    <div class="filters">
      <div class="rowitem">
        <label for="statutFilter"><b>Filtrer par statut</b></label>
        <select id="statutFilter" [ngModel]="statutFilter()" (ngModelChange)="onFilterStatut($event)">
          <option value="">Tous</option>
          <option value="EN_ATTENTE">En Attente</option>
          <option value="APPROUVEE">Approuvée</option>
          <option value="REJETEE">Rejetée</option>
          <option value="ANNULEE">Annulée</option>
        </select>
      </div>

      <div class="rowitem">
        <label for="clientFilter"><b>Filtrer par client</b></label>
        <input id="clientFilter" type="text" placeholder="Nom ou email"
               [ngModel]="clientFilter()" (ngModelChange)="onFilterClient($event)" />
      </div>

      <div class="inline-actions">
        <button class="btn ghost" type="button" (click)="clearFilters()">Effacer</button>
        <button class="btn success" type="button" (click)="refresh()" [disabled]="loading()">
          {{ loading() ? 'Chargement…' : 'Actualiser' }}
        </button>
      </div>
    </div>

    <!-- LOADING -->
    <div *ngIf="loading()" class="loading-container">
      <div class="spinner"></div>
      <p>Chargement des demandes...</p>
    </div>

    <!-- LISTE DES DEMANDES -->
    <div *ngIf="!loading()" class="list">
      <div *ngIf="demandesFiltered().length === 0" class="empty-state">
        <p>{{ getEmptyMessage() }}</p>
      </div>

      <div *ngFor="let d of demandesFiltered()" class="rowitem demande" [ngClass]="getRowClass(d.statut)">
        <div class="demande-info">
          <b>{{ getClientDisplayName(d) }}</b>
          <small>Compte: {{ d.compte?.numeroCompte || d.numeroCompte }} — {{ d.pages }} pages</small>
          <div *ngIf="d.motif"><i>Motif:</i> {{ d.motif }}</div>
        </div>

        <div class="demande-meta">
          <span class="badge" [ngClass]="badgeClass(d.statut)">{{ getStatusLabel(d.statut) }}</span>
          <small>{{ d.dateDemande | date:'dd/MM/yyyy' }}</small>
        </div>

        <div class="inline-actions">
          <button class="btn info" type="button" (click)="voirDetails(d)">👁️ Détails</button>

          <ng-container *ngIf="canAct(d)">
            <button class="btn success" type="button" (click)="approuver(d)" [disabled]="submitting()">✓ Approuver</button>
            <button class="btn danger" type="button" (click)="rejeter(d)" [disabled]="submitting()">✗ Rejeter</button>
          </ng-container>

          <button class="btn ghost danger" type="button" (click)="supprimer(d)" [disabled]="submitting()">🗑️ Supprimer</button>
        </div>
      </div>
    </div>
  </div>
</div>
